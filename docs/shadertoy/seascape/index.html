<!DOCTYPE html>
<html lang="en">
  
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="Typelevel Laika + Helium Theme" />
  <title>Seascape</title>
  
  
  <meta name="description" content="Scala 3 to GLSL transpiler"/>
  
  
  
  <link rel="icon" sizes="32x32" type="image/png" href="../../img/favicon.png"/>
  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700">
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Mono:500">
  
  <link rel="stylesheet" type="text/css" href="../../helium/site/icofont.min.css" />
    <link rel="stylesheet" type="text/css" href="../../helium/site/laika-helium.css" />
    <link rel="stylesheet" type="text/css" href="../../css/custom.css" />
  <script src="../../helium/site/laika-helium.js"></script>
  
  
  <script> /* for avoiding page load transitions */ </script>
</head>

  <body>

    <header id="top-bar" class="light-default dark-default">

  <div class="row">
    <a id="nav-icon">
      <i class="icofont-laika navigationMenu" title="Navigation">&#xefa2;</i>
    </a>
    
    
  </div>

  <a class="icon-link glyph-link" href="../../documentation/"><i class="icofont-laika home" title="Home">&#xef47;</i></a>

  <div class="row links">
    
    <a class="button-link" href="https://ultraviolet.indigoengine.io/live_demos">Live Demos</a>
    
    <a class="button-link" href="https://discord.gg/b5CD47g">Discord</a>
    
    <a class="button-link" href="https://github.com/PurpleKingdomGames/ultraviolet">Github</a>
    
  </div>  

</header>
    
    <nav id="sidebar">

  <div class="row">
    
    <a class="button-link" href="https://ultraviolet.indigoengine.io/live_demos">Live Demos</a>
    
    <a class="button-link" href="https://discord.gg/b5CD47g">Discord</a>
    
    <a class="button-link" href="https://github.com/PurpleKingdomGames/ultraviolet">Github</a>
    
  </div>

  <ul class="nav-list">
    <li class="level1 nav-node"><a href="../../documentation/">Ultraviolet</a></li>
    <li class="level2 nav-leaf"><a href="../../documentation/shaders-and-glsl.html">Shaders and GLSL</a></li>
    <li class="level2 nav-leaf"><a href="../../documentation/motivation.html">Motivation</a></li>
    <li class="level2 nav-node"><a href="../../documentation/guide/">Writing Shaders</a></li>
    <li class="level3 nav-leaf"><a href="../../documentation/guide/scala-vs-glsl.html">Scala 3 vs GLSL</a></li>
    <li class="level3 nav-leaf"><a href="../../documentation/guide/premultiplied-alpha.html">Premultiplied Alpha</a></li>
    <li class="level3 nav-leaf"><a href="../../documentation/guide/gotchas.html">Gotcha&#39;s, foot guns, and weird stuff</a></li>
    <li class="level3 nav-leaf"><a href="../../documentation/guide/shadertoy.html">Shadertoy</a></li>
    <li class="level1 nav-node"><a href="../../examples/">Examples</a></li>
    <li class="level2 nav-node"><a href="../../examples/fragment/">Fragment</a></li>
    <li class="level3 nav-node"><a href="../../examples/fragment/basics/">Basics</a></li>
    <li class="level4 nav-leaf"><a href="../../examples/fragment/basics/colour-constants/">Colour Constants</a></li>
    <li class="level4 nav-leaf"><a href="../../examples/fragment/basics/colour-interpolators/">Colour Interpolators</a></li>
    <li class="level4 nav-leaf"><a href="../../examples/fragment/basics/colours/">Colours</a></li>
    <li class="level4 nav-leaf"><a href="../../examples/fragment/basics/minimal/">Minimal Fragment Shader Setup</a></li>
    <li class="level3 nav-node"><a href="../../examples/fragment/demos/">Demos</a></li>
    <li class="level4 nav-leaf"><a href="../../examples/fragment/demos/campfire/">Campfire Demo</a></li>
    <li class="level4 nav-leaf"><a href="../../examples/fragment/demos/glowing-star/">Glowing Star Demo</a></li>
    <li class="level4 nav-leaf"><a href="../../examples/fragment/demos/pulsingbox/">Pulsing Box Demo</a></li>
    <li class="level3 nav-node"><a href="../../examples/fragment/noise/">Noise</a></li>
    <li class="level4 nav-leaf"><a href="../../examples/fragment/noise/cellular-noise/">Cellular Noise</a></li>
    <li class="level4 nav-leaf"><a href="../../examples/fragment/noise/classic-perlin-noise/">Classic Perlin Noise</a></li>
    <li class="level4 nav-leaf"><a href="../../examples/fragment/noise/gradient-noise/">Gradient Noise</a></li>
    <li class="level4 nav-leaf"><a href="../../examples/fragment/noise/simplex-noise/">Simplex Noise</a></li>
    <li class="level4 nav-leaf"><a href="../../examples/fragment/noise/white-noise/">White Noise</a></li>
    <li class="level3 nav-node"><a href="../../examples/fragment/patterns/">Patterns</a></li>
    <li class="level4 nav-leaf"><a href="../../examples/fragment/patterns/grid/">Grid</a></li>
    <li class="level4 nav-leaf"><a href="../../examples/fragment/patterns/rainbow/">Rainbow</a></li>
    <li class="level4 nav-leaf"><a href="../../examples/fragment/patterns/simple-voronoi/">Voronoi Example</a></li>
    <li class="level4 nav-leaf"><a href="../../examples/fragment/patterns/stripes/">Stripes</a></li>
    <li class="level4 nav-leaf"><a href="../../examples/fragment/patterns/wavy-stripes/">Wavy stripes</a></li>
    <li class="level3 nav-node"><a href="../../examples/fragment/sdf/">Sdf</a></li>
    <li class="level4 nav-leaf"><a href="../../examples/fragment/sdf/box/">Square SDF</a></li>
    <li class="level4 nav-leaf"><a href="../../examples/fragment/sdf/circle/">Circle SDF</a></li>
    <li class="level4 nav-leaf"><a href="../../examples/fragment/sdf/hexagon/">Hexagon SDF</a></li>
    <li class="level4 nav-leaf"><a href="../../examples/fragment/sdf/segment/">Segment SDF</a></li>
    <li class="level4 nav-leaf"><a href="../../examples/fragment/sdf/star/">Star SDF</a></li>
    <li class="level4 nav-leaf"><a href="../../examples/fragment/sdf/triangle/">Triangle SDF</a></li>
    <li class="level3 nav-node"><a href="../../examples/fragment/shapes/">Shapes</a></li>
    <li class="level4 nav-leaf"><a href="../../examples/fragment/shapes/doughnut/">Doughnut</a></li>
    <li class="level4 nav-leaf"><a href="../../examples/fragment/shapes/metaballs/">Metaballs</a></li>
    <li class="level3 nav-node"><a href="../../examples/fragment/textures/">Textures</a></li>
    <li class="level4 nav-leaf"><a href="../../examples/fragment/textures/basic-texture-use/">Basic texture use</a></li>
    <li class="level4 nav-leaf"><a href="../../examples/fragment/textures/blending-textures/">Blending Textures</a></li>
    <li class="level4 nav-leaf"><a href="../../examples/fragment/textures/specifying-texture-coords/">Specifying Texture Coordinates</a></li>
    <li class="level2 nav-node"><a href="../../examples/language-features/">Language features</a></li>
    <li class="level3 nav-leaf"><a href="../../examples/language-features/imports/">Using Imports &amp; Shared Code</a></li>
    <li class="level3 nav-leaf"><a href="../../examples/language-features/ubos/">Supplying Data with UBOs</a></li>
    <li class="level2 nav-node"><a href="../../examples/vertex/">Vertex</a></li>
    <li class="level3 nav-leaf"><a href="../../examples/vertex/manipulatinguvs/">Manipulating UVs</a></li>
    <li class="level3 nav-leaf"><a href="../../examples/vertex/minimal/">Minimal Vertex Shader Setup</a></li>
    <li class="level3 nav-leaf"><a href="../../examples/vertex/movingvertices/">Moving Vertices</a></li>
    <li class="level1 nav-node"><a href="../">Shadertoy</a></li>
    <li class="level2 nav-leaf"><a href="../default/">Default</a></li>
    <li class="level2 nav-leaf"><a href="../plasma/">Plasma</a></li>
    <li class="level2 active nav-leaf"><a href="#">Seascape</a></li>
  </ul>

</nav>

    <div id="container">

      
<nav id="page-nav">
  <p class="header"><a href="#">Seascape</a></p>

  <ul class="nav-list">
    <li class="level1 nav-leaf"><a href="#the-glsl-output">The GLSL Output</a></li>
    <li class="level1 nav-leaf"><a href="#demo">Demo</a></li>
    <li class="level1 nav-leaf"><a href="#links">Links</a></li>
    <li class="level1 nav-leaf"><a href="#ultraviolet-shadertoy-code">Ultraviolet Shadertoy code</a></li>
  </ul>

  <p class="footer"></p>
</nav>


      <main class="content">

        <h1 id="seascape" class="title">Seascape</h1>
        <blockquote>This is a <a href="https://www.shadertoy.com/">Shadertoy</a> example. Because of the way this docs are built, its housed in a minimal Indigo project for built purposes, but the shader code isn&#39;t run because it&#39;s incompatible with Indigo, so all you get is a black screen.</blockquote>
        <p>This example is a port of &#39;Seascape&#39; by <a href="https://www.shadertoy.com/user/TDM">TDM</a>, and you can view it here: <a href="https://www.shadertoy.com/view/Ms2SD1">https://www.shadertoy.com/view/Ms2SD1</a></p>
        
        <h2 id="the-glsl-output" class="section"><a class="anchor-link left" href="#the-glsl-output"><i class="icofont-laika link">&#xef71;</i></a>The GLSL Output</h2>
        <p>This is the shadertoy compatible GLSL code that Ultraviolet manufactures:</p>
        <pre><code class="glsl">const int NUM_STEPS=8;
const float PI=3.141592;
const float EPSILON=0.001;
#define EPSILON_NRM 0.1/iResolution.x
const int ITER_GEOMETRY=3;
const int ITER_FRAGMENT=5;
const float SEA_HEIGHT=0.6;
const float SEA_CHOPPY=4.0;
const float SEA_SPEED=0.8;
const float SEA_FREQ=0.16;
const vec3 SEA_BASE=vec3(0.0,0.09,0.18);
const vec3 SEA_WATER_COLOR=vec3(0.8,0.9,0.6)*0.6;
#define SEA_TIME 1.0+(iTime*SEA_SPEED)
const mat2 octave_m=mat2(1.6,1.2,-1.2,1.6);
mat3 fromEuler(in vec3 ang){
  vec2 a1=vec2(sin(ang.x),cos(ang.x));
  vec2 a2=vec2(sin(ang.y),cos(ang.y));
  vec2 a3=vec2(sin(ang.z),cos(ang.z));
  mat3 m;
  m[0]=(vec3((a1.y*a3.y)+((a1.x*a2.x)*a3.x),((a1.y*a2.x)*a3.x)+(a3.y*a1.x),(-a2.y)*a3.x));
  m[1]=(vec3((-a2.y)*a1.x,a1.y*a2.y,a2.x));
  m[2]=(vec3(((a3.y*a1.x)*a2.x)+(a1.y*a3.x),(a1.x*a3.x)-((a1.y*a3.y)*a2.x),a2.y*a3.y));
  return m;
}
float hash(in vec2 p){
  float h=dot(p,vec2(127.1,311.7));
  return fract(sin(h)*43758.547);
}
float noise(in vec2 p){
  vec2 i=floor(p);
  vec2 f=fract(p);
  vec2 u=(f*f)*(3.0-(2.0*f));
  return (-1.0)+(2.0*(mix(mix(hash(i+vec2(0.0,0.0)),hash(i+vec2(1.0,0.0)),u.x),mix(hash(i+vec2(0.0,1.0)),hash(i+vec2(1.0,1.0)),u.x),u.y)));
}
float diffuse(in vec3 n,in vec3 l,in float p){
  return pow((dot(n,l)*0.4)+0.6,p);
}
float specular(in vec3 n,in vec3 l,in vec3 e,in float s){
  float nrm=(s+8.0)/(PI*8.0);
  return pow(max(dot(reflect(e,n),l),0.0),s)*nrm;
}
vec3 getSkyColor(in vec3 c){
  vec3 e=vec3(c.x,((max(c.y,0.0)*0.8)+0.2)*0.18,c.z);
  return (vec3(pow(1.0-e.y,2.0),1.0-e.y,0.6+((1.0-e.y)*0.4)))*1.1;
}
float sea_octave(in vec2 uv,in float choppy){
  float n=noise(uv);
  vec2 uv2=vec2(uv.x+n,uv.y+n);
  vec2 wv=1.0-abs(sin(uv2));
  vec2 swv=abs(cos(uv2));
  wv=mix(wv,swv,wv);
  return pow(1.0-(pow(wv.x*wv.y,0.65)),choppy);
}
float map(in vec3 p){
  float freq=SEA_FREQ;
  float amp=SEA_HEIGHT;
  float choppy=SEA_CHOPPY;
  vec2 uv=p.xz;
  uv=vec2(uv.x*0.75,uv.y);
  float d=0.0;
  float h=0.0;
  for(int val0=0;val0&lt;ITER_GEOMETRY;val0=val0+1){
    d=sea_octave((uv+SEA_TIME)*freq,choppy);
    d=d+(sea_octave((uv-SEA_TIME)*freq,choppy));
    h=h+(d*amp);
    uv=uv*octave_m;
    freq=freq*1.9;
    amp=amp*0.22;
    choppy=mix(choppy,1.0,0.2);
  }
  return p.y-h;
}
vec3 getSeaColor(in vec3 p,in vec3 n,in vec3 l,in vec3 eye,in vec3 dist){
  float fresnel=clamp(1.0-(dot(n,-eye)),0.0,1.0);
  fresnel=pow(fresnel,3.0)*0.5;
  vec3 reflected=getSkyColor(reflect(eye,n));
  vec3 refracted=SEA_BASE+((diffuse(n,l,80.0)*SEA_WATER_COLOR)*0.12);
  vec3 color=mix(refracted,reflected,fresnel);
  float atten=max(1.0-(dot(dist,dist)*0.001),0.0);
  color=color+(((SEA_WATER_COLOR*(p.y-SEA_HEIGHT))*0.18)*atten);
  color=color+vec3(specular(n,l,eye,60.0));
  return color;
}
vec3 getNormal(in vec3 p,in float eps){
  vec3 n;
  n=vec3(n.x,map(p),n.z);
  n=vec3((map(vec3(p.x+eps,p.y,p.z)))-n.y,n.y,n.z);
  n=vec3(n.x,n.y,(map(vec3(p.x,p.y,p.z+eps)))-n.y);
  n=vec3(n.x,eps,n.z);
  return normalize(n);
}
vec3 pOut=vec3(0.0);
float heightMapTracing(in vec3 ori,in vec3 dir){
  float tm=0.0;
  float tx=1000.0;
  float hx=map(ori+(dir*tx));
  float res=0.0;
  if(hx&gt;0.0){
    pOut=ori+(dir*tx);
    res=tx;
  }else{
    float hm=map(ori+(dir*tm));
    float tmid=0.0;
    for(int val1=0;val1&lt;NUM_STEPS;val1=val1+1){
      tmid=mix(tm,tx,hm/(hm-hx));
      pOut=ori+(dir*tmid);
      float hmid=map(pOut);
      if(hmid&lt;0.0){
        tx=tmid;
        hx=hmid;
      }else{
        tm=tmid;
        hm=hmid;
      }
    }
    res=tmid;
  }
  return res;
}
vec3 getPixel(in vec2 coord,in float time){
  vec2 uv=coord/iResolution.xy;
  uv=(uv*2.0)-1.0;
  uv=vec2(uv.x*(iResolution.x/iResolution.y),uv.y);
  vec3 ang=vec3((sin(time*3.0))*0.1,(sin(time)*0.2)+0.3,time);
  vec3 ori=vec3(0.0,3.5,time*5.0);
  vec3 dir=normalize(vec3(uv.xy,-2.0));
  dir=vec3(dir.xy,dir.z+(length(uv)*0.14));
  dir=normalize(dir)*fromEuler(ang);
  heightMapTracing(ori,dir);
  vec3 dist=pOut-ori;
  vec3 n=getNormal(pOut,dot(dist,dist)*EPSILON_NRM);
  vec3 light=normalize(vec3(0.0,1.0,0.8));
  return mix(getSkyColor(dir),getSeaColor(pOut,n,light,dir,dist),pow(smoothstep(0.0,-0.02,dir.y),0.2));
}
void mainImage(out vec4 fragColor,in vec2 fragCoord){
  float time=(iTime*0.3)+(iMouse.x*0.01);
  vec3 color=getPixel(fragCoord,time);
  fragColor=vec4(pow(color,vec3(0.65)),1.0);
}</code></pre>
        
        <h2 id="demo" class="section"><a class="anchor-link left" href="#demo"><i class="icofont-laika link">&#xef71;</i></a>Demo</h2>
        <div id="live-demo" style="border:2px solid #e400ff;width:400px;height:400px;background:#a888db33;color: #e400ff;display:flex;align-items:center;justify-content:center;cursor:pointer;">
          ▶  Click to play
        </div>
        <script>
  document.getElementById("live-demo").addEventListener("click", function() {
    this.innerHTML = '<iframe width="396" height="396" src="https://ultraviolet.indigoengine.io/live_demos/shadertoy/seascape/index.html" frameborder="0" allow="autoplay; encrypted-media" scrolling="no"></iframe>';
  });
</script>
        
        <h2 id="links" class="section"><a class="anchor-link left" href="#links"><i class="icofont-laika link">&#xef71;</i></a>Links</h2>
        <ul>
          <li><a href="https://github.com/PurpleKingdomGames/ultraviolet-docs/blob/main/shadertoy/seascape">View example code</a></li>
        </ul>
        <ul>
          <li><a href="https://ultraviolet.indigoengine.io/live_demos/shadertoy/seascape/index.html">Live demo</a></li>
        </ul>
        
        <h2 id="ultraviolet-shadertoy-code" class="section"><a class="anchor-link left" href="#ultraviolet-shadertoy-code"><i class="icofont-laika link">&#xef71;</i></a>Ultraviolet Shadertoy code</h2>
        <p>Reminder: The live demo will not work, below is the Shadertoy compatible code.</p>
        <pre><code class="nohighlight"><span class="keyword">object</span><span> </span><span class="type-name">ShaderToyExample</span><span>:

  </span><span class="identifier">inline</span><span> </span><span class="keyword">def</span><span> </span><span class="declaration-name">image</span><span> =
    </span><span class="type-name">Shader</span><span>[</span><span class="type-name">ShaderToyEnv</span><span>, </span><span class="type-name">Unit</span><span>] { </span><span class="identifier">env</span><span> =&gt;
      </span><span class="annotation">@const</span><span> </span><span class="keyword">val</span><span> </span><span class="type-name">NUM_STEPS</span><span>: </span><span class="type-name">Int</span><span>      = </span><span class="number-literal">8</span><span>
      </span><span class="annotation">@const</span><span> </span><span class="keyword">val</span><span> </span><span class="type-name">PI</span><span>: </span><span class="type-name">Float</span><span>           = </span><span class="number-literal">3.141592f</span><span>
      </span><span class="annotation">@const</span><span> </span><span class="keyword">val</span><span> </span><span class="type-name">EPSILON</span><span>: </span><span class="type-name">Float</span><span>      = </span><span class="number-literal">1e-3f</span><span>
      </span><span class="annotation">@define</span><span> </span><span class="keyword">val</span><span> </span><span class="type-name">EPSILON_NRM</span><span>: </span><span class="type-name">Float</span><span> = </span><span class="number-literal">0.1f</span><span> / </span><span class="identifier">env</span><span>.</span><span class="identifier">iResolution</span><span>.</span><span class="identifier">x</span><span>

      </span><span class="comment">// sea
</span><span>      </span><span class="annotation">@const</span><span> </span><span class="keyword">val</span><span> </span><span class="type-name">ITER_GEOMETRY</span><span>: </span><span class="type-name">Int</span><span>    = </span><span class="number-literal">3</span><span>
      </span><span class="annotation">@const</span><span> </span><span class="keyword">val</span><span> </span><span class="type-name">ITER_FRAGMENT</span><span>: </span><span class="type-name">Int</span><span>    = </span><span class="number-literal">5</span><span>
      </span><span class="annotation">@const</span><span> </span><span class="keyword">val</span><span> </span><span class="type-name">SEA_HEIGHT</span><span>: </span><span class="type-name">Float</span><span>     = </span><span class="number-literal">0.6f</span><span>
      </span><span class="annotation">@const</span><span> </span><span class="keyword">val</span><span> </span><span class="type-name">SEA_CHOPPY</span><span>: </span><span class="type-name">Float</span><span>     = </span><span class="number-literal">4.0f</span><span>
      </span><span class="annotation">@const</span><span> </span><span class="keyword">val</span><span> </span><span class="type-name">SEA_SPEED</span><span>: </span><span class="type-name">Float</span><span>      = </span><span class="number-literal">0.8f</span><span>
      </span><span class="annotation">@const</span><span> </span><span class="keyword">val</span><span> </span><span class="type-name">SEA_FREQ</span><span>: </span><span class="type-name">Float</span><span>       = </span><span class="number-literal">0.16f</span><span>
      </span><span class="annotation">@const</span><span> </span><span class="keyword">val</span><span> </span><span class="type-name">SEA_BASE</span><span>: </span><span class="identifier">vec3</span><span>        = </span><span class="identifier">vec3</span><span>(</span><span class="number-literal">0.0f</span><span>, </span><span class="number-literal">0.09f</span><span>, </span><span class="number-literal">0.18f</span><span>)
      </span><span class="annotation">@const</span><span> </span><span class="keyword">val</span><span> </span><span class="type-name">SEA_WATER_COLOR</span><span>: </span><span class="identifier">vec3</span><span> = </span><span class="identifier">vec3</span><span>(</span><span class="number-literal">0.8f</span><span>, </span><span class="number-literal">0.9f</span><span>, </span><span class="number-literal">0.6f</span><span>) * </span><span class="number-literal">0.6f</span><span>
      </span><span class="annotation">@define</span><span> </span><span class="keyword">val</span><span> </span><span class="type-name">SEA_TIME</span><span>: </span><span class="type-name">Float</span><span>      = </span><span class="number-literal">1.0f</span><span> + </span><span class="identifier">env</span><span>.</span><span class="identifier">iTime</span><span> * </span><span class="type-name">SEA_SPEED</span><span>
      </span><span class="annotation">@const</span><span> </span><span class="keyword">val</span><span> </span><span class="identifier">octave_m</span><span>: </span><span class="identifier">mat2</span><span>        = </span><span class="identifier">mat2</span><span>(</span><span class="number-literal">1.6f</span><span>, </span><span class="number-literal">1.2f</span><span>, -</span><span class="number-literal">1.2f</span><span>, </span><span class="number-literal">1.6f</span><span>)

      </span><span class="comment">// math
</span><span>      </span><span class="keyword">def</span><span> </span><span class="declaration-name">fromEuler</span><span>(</span><span class="identifier">ang</span><span>: </span><span class="identifier">vec3</span><span>): </span><span class="identifier">mat3</span><span> =
        </span><span class="keyword">val</span><span> </span><span class="identifier">a1</span><span>: </span><span class="identifier">vec2</span><span> = </span><span class="identifier">vec2</span><span>(</span><span class="identifier">sin</span><span>(</span><span class="identifier">ang</span><span>.</span><span class="identifier">x</span><span>), </span><span class="identifier">cos</span><span>(</span><span class="identifier">ang</span><span>.</span><span class="identifier">x</span><span>))
        </span><span class="keyword">val</span><span> </span><span class="identifier">a2</span><span>: </span><span class="identifier">vec2</span><span> = </span><span class="identifier">vec2</span><span>(</span><span class="identifier">sin</span><span>(</span><span class="identifier">ang</span><span>.</span><span class="identifier">y</span><span>), </span><span class="identifier">cos</span><span>(</span><span class="identifier">ang</span><span>.</span><span class="identifier">y</span><span>))
        </span><span class="keyword">val</span><span> </span><span class="identifier">a3</span><span>: </span><span class="identifier">vec2</span><span> = </span><span class="identifier">vec2</span><span>(</span><span class="identifier">sin</span><span>(</span><span class="identifier">ang</span><span>.</span><span class="identifier">z</span><span>), </span><span class="identifier">cos</span><span>(</span><span class="identifier">ang</span><span>.</span><span class="identifier">z</span><span>))
        </span><span class="keyword">val</span><span> </span><span class="identifier">m</span><span>: </span><span class="identifier">mat3</span><span>  = </span><span class="literal-value">null</span><span>
        </span><span class="identifier">m</span><span>(</span><span class="number-literal">0</span><span>) =
          </span><span class="identifier">vec3</span><span>(</span><span class="identifier">a1</span><span>.</span><span class="identifier">y</span><span> * </span><span class="identifier">a3</span><span>.</span><span class="identifier">y</span><span> + </span><span class="identifier">a1</span><span>.</span><span class="identifier">x</span><span> * </span><span class="identifier">a2</span><span>.</span><span class="identifier">x</span><span> * </span><span class="identifier">a3</span><span>.</span><span class="identifier">x</span><span>, </span><span class="identifier">a1</span><span>.</span><span class="identifier">y</span><span> * </span><span class="identifier">a2</span><span>.</span><span class="identifier">x</span><span> * </span><span class="identifier">a3</span><span>.</span><span class="identifier">x</span><span> + </span><span class="identifier">a3</span><span>.</span><span class="identifier">y</span><span> * </span><span class="identifier">a1</span><span>.</span><span class="identifier">x</span><span>, -</span><span class="identifier">a2</span><span>.</span><span class="identifier">y</span><span> * </span><span class="identifier">a3</span><span>.</span><span class="identifier">x</span><span>)
        </span><span class="identifier">m</span><span>(</span><span class="number-literal">1</span><span>) = </span><span class="identifier">vec3</span><span>(-</span><span class="identifier">a2</span><span>.</span><span class="identifier">y</span><span> * </span><span class="identifier">a1</span><span>.</span><span class="identifier">x</span><span>, </span><span class="identifier">a1</span><span>.</span><span class="identifier">y</span><span> * </span><span class="identifier">a2</span><span>.</span><span class="identifier">y</span><span>, </span><span class="identifier">a2</span><span>.</span><span class="identifier">x</span><span>)
        </span><span class="identifier">m</span><span>(</span><span class="number-literal">2</span><span>) = </span><span class="identifier">vec3</span><span>(</span><span class="identifier">a3</span><span>.</span><span class="identifier">y</span><span> * </span><span class="identifier">a1</span><span>.</span><span class="identifier">x</span><span> * </span><span class="identifier">a2</span><span>.</span><span class="identifier">x</span><span> + </span><span class="identifier">a1</span><span>.</span><span class="identifier">y</span><span> * </span><span class="identifier">a3</span><span>.</span><span class="identifier">x</span><span>, </span><span class="identifier">a1</span><span>.</span><span class="identifier">x</span><span> * </span><span class="identifier">a3</span><span>.</span><span class="identifier">x</span><span> - </span><span class="identifier">a1</span><span>.</span><span class="identifier">y</span><span> * </span><span class="identifier">a3</span><span>.</span><span class="identifier">y</span><span> * </span><span class="identifier">a2</span><span>.</span><span class="identifier">x</span><span>, </span><span class="identifier">a2</span><span>.</span><span class="identifier">y</span><span> * </span><span class="identifier">a3</span><span>.</span><span class="identifier">y</span><span>)
        </span><span class="identifier">m</span><span>

      </span><span class="keyword">def</span><span> </span><span class="declaration-name">hash</span><span>(</span><span class="identifier">p</span><span>: </span><span class="identifier">vec2</span><span>): </span><span class="type-name">Float</span><span> =
        </span><span class="keyword">val</span><span> </span><span class="identifier">h</span><span>: </span><span class="type-name">Float</span><span> = </span><span class="identifier">dot</span><span>(</span><span class="identifier">p</span><span>, </span><span class="identifier">vec2</span><span>(</span><span class="number-literal">127.1</span><span>, </span><span class="number-literal">311.7</span><span>))
        </span><span class="identifier">fract</span><span>(</span><span class="identifier">sin</span><span>(</span><span class="identifier">h</span><span>) * </span><span class="number-literal">43758.5453123f</span><span>)

      </span><span class="keyword">def</span><span> </span><span class="declaration-name">noise</span><span>(</span><span class="identifier">p</span><span>: </span><span class="identifier">vec2</span><span>): </span><span class="type-name">Float</span><span> =
        </span><span class="keyword">val</span><span> </span><span class="identifier">i</span><span>: </span><span class="identifier">vec2</span><span> = </span><span class="identifier">floor</span><span>(</span><span class="identifier">p</span><span>)
        </span><span class="keyword">val</span><span> </span><span class="identifier">f</span><span>: </span><span class="identifier">vec2</span><span> = </span><span class="identifier">fract</span><span>(</span><span class="identifier">p</span><span>)
        </span><span class="keyword">val</span><span> </span><span class="identifier">u</span><span>: </span><span class="identifier">vec2</span><span> = </span><span class="identifier">f</span><span> * </span><span class="identifier">f</span><span> * (</span><span class="number-literal">3.0f</span><span> - </span><span class="number-literal">2.0f</span><span> * </span><span class="identifier">f</span><span>)

        -</span><span class="number-literal">1.0f</span><span> + </span><span class="number-literal">2.0f</span><span> *
          </span><span class="identifier">mix</span><span>(
            </span><span class="identifier">mix</span><span>(</span><span class="identifier">hash</span><span>(</span><span class="identifier">i</span><span> + </span><span class="identifier">vec2</span><span>(</span><span class="number-literal">0.0f</span><span>, </span><span class="number-literal">0.0f</span><span>)), </span><span class="identifier">hash</span><span>(</span><span class="identifier">i</span><span> + </span><span class="identifier">vec2</span><span>(</span><span class="number-literal">1.0f</span><span>, </span><span class="number-literal">0.0f</span><span>)), </span><span class="identifier">u</span><span>.</span><span class="identifier">x</span><span>),
            </span><span class="identifier">mix</span><span>(</span><span class="identifier">hash</span><span>(</span><span class="identifier">i</span><span> + </span><span class="identifier">vec2</span><span>(</span><span class="number-literal">0.0f</span><span>, </span><span class="number-literal">1.0f</span><span>)), </span><span class="identifier">hash</span><span>(</span><span class="identifier">i</span><span> + </span><span class="identifier">vec2</span><span>(</span><span class="number-literal">1.0f</span><span>, </span><span class="number-literal">1.0f</span><span>)), </span><span class="identifier">u</span><span>.</span><span class="identifier">x</span><span>),
            </span><span class="identifier">u</span><span>.</span><span class="identifier">y</span><span>
          )

      </span><span class="comment">// lighting
</span><span>      </span><span class="keyword">def</span><span> </span><span class="declaration-name">diffuse</span><span>(</span><span class="identifier">n</span><span>: </span><span class="identifier">vec3</span><span>, </span><span class="identifier">l</span><span>: </span><span class="identifier">vec3</span><span>, </span><span class="identifier">p</span><span>: </span><span class="type-name">Float</span><span>): </span><span class="type-name">Float</span><span> =
        </span><span class="identifier">pow</span><span>(</span><span class="identifier">dot</span><span>(</span><span class="identifier">n</span><span>, </span><span class="identifier">l</span><span>) * </span><span class="number-literal">0.4f</span><span> + </span><span class="number-literal">0.6f</span><span>, </span><span class="identifier">p</span><span>)

      </span><span class="keyword">def</span><span> </span><span class="declaration-name">specular</span><span>(</span><span class="identifier">n</span><span>: </span><span class="identifier">vec3</span><span>, </span><span class="identifier">l</span><span>: </span><span class="identifier">vec3</span><span>, </span><span class="identifier">e</span><span>: </span><span class="identifier">vec3</span><span>, </span><span class="identifier">s</span><span>: </span><span class="type-name">Float</span><span>): </span><span class="type-name">Float</span><span> =
        </span><span class="keyword">val</span><span> </span><span class="identifier">nrm</span><span>: </span><span class="type-name">Float</span><span> = (</span><span class="identifier">s</span><span> + </span><span class="number-literal">8.0f</span><span>) / (</span><span class="type-name">PI</span><span> * </span><span class="number-literal">8.0f</span><span>)
        </span><span class="identifier">pow</span><span>(</span><span class="identifier">max</span><span>(</span><span class="identifier">dot</span><span>(</span><span class="identifier">reflect</span><span>(</span><span class="identifier">e</span><span>, </span><span class="identifier">n</span><span>), </span><span class="identifier">l</span><span>), </span><span class="number-literal">0.0f</span><span>), </span><span class="identifier">s</span><span>) * </span><span class="identifier">nrm</span><span>

      </span><span class="comment">// sky
</span><span>      </span><span class="keyword">def</span><span> </span><span class="declaration-name">getSkyColor</span><span>(</span><span class="identifier">c</span><span>: </span><span class="identifier">vec3</span><span>): </span><span class="identifier">vec3</span><span> =
        </span><span class="keyword">val</span><span> </span><span class="identifier">e</span><span> = </span><span class="identifier">vec3</span><span>(
          </span><span class="identifier">c</span><span>.</span><span class="identifier">x</span><span>,
          (</span><span class="identifier">max</span><span>(</span><span class="identifier">c</span><span>.</span><span class="identifier">y</span><span>, </span><span class="number-literal">0.0f</span><span>) * </span><span class="number-literal">0.8f</span><span> + </span><span class="number-literal">0.2f</span><span>) * </span><span class="number-literal">0.18f</span><span>,
          </span><span class="identifier">c</span><span>.</span><span class="identifier">z</span><span>
        )
        </span><span class="identifier">vec3</span><span>(</span><span class="identifier">pow</span><span>(</span><span class="number-literal">1.0f</span><span> - </span><span class="identifier">e</span><span>.</span><span class="identifier">y</span><span>, </span><span class="number-literal">2.0f</span><span>), </span><span class="number-literal">1.0f</span><span> - </span><span class="identifier">e</span><span>.</span><span class="identifier">y</span><span>, </span><span class="number-literal">0.6f</span><span> + (</span><span class="number-literal">1.0f</span><span> - </span><span class="identifier">e</span><span>.</span><span class="identifier">y</span><span>) * </span><span class="number-literal">0.4f</span><span>) * </span><span class="number-literal">1.1f</span><span>

      </span><span class="comment">// sea
</span><span>      </span><span class="keyword">def</span><span> </span><span class="declaration-name">sea_octave</span><span>(</span><span class="identifier">uv</span><span>: </span><span class="identifier">vec2</span><span>, </span><span class="identifier">choppy</span><span>: </span><span class="type-name">Float</span><span>): </span><span class="type-name">Float</span><span> =
        </span><span class="keyword">val</span><span> </span><span class="identifier">n</span><span>         = </span><span class="identifier">noise</span><span>(</span><span class="identifier">uv</span><span>)
        </span><span class="keyword">val</span><span> </span><span class="identifier">uv2</span><span>       = </span><span class="identifier">vec2</span><span>(</span><span class="identifier">uv</span><span>.</span><span class="identifier">x</span><span> + </span><span class="identifier">n</span><span>, </span><span class="identifier">uv</span><span>.</span><span class="identifier">y</span><span> + </span><span class="identifier">n</span><span>)
        </span><span class="keyword">var</span><span> </span><span class="identifier">wv</span><span>: </span><span class="identifier">vec2</span><span>  = </span><span class="number-literal">1.0f</span><span> - </span><span class="identifier">abs</span><span>(</span><span class="identifier">sin</span><span>(</span><span class="identifier">uv2</span><span>))
        </span><span class="keyword">val</span><span> </span><span class="identifier">swv</span><span>: </span><span class="identifier">vec2</span><span> = </span><span class="identifier">abs</span><span>(</span><span class="identifier">cos</span><span>(</span><span class="identifier">uv2</span><span>))
        </span><span class="identifier">wv</span><span> = </span><span class="identifier">mix</span><span>(</span><span class="identifier">wv</span><span>, </span><span class="identifier">swv</span><span>, </span><span class="identifier">wv</span><span>)
        </span><span class="identifier">pow</span><span>(</span><span class="number-literal">1.0f</span><span> - </span><span class="identifier">pow</span><span>(</span><span class="identifier">wv</span><span>.</span><span class="identifier">x</span><span> * </span><span class="identifier">wv</span><span>.</span><span class="identifier">y</span><span>, </span><span class="number-literal">0.65f</span><span>), </span><span class="identifier">choppy</span><span>)

      </span><span class="keyword">def</span><span> </span><span class="declaration-name">map</span><span>(</span><span class="identifier">p</span><span>: </span><span class="identifier">vec3</span><span>): </span><span class="type-name">Float</span><span> = {
        </span><span class="keyword">var</span><span> </span><span class="identifier">freq</span><span>: </span><span class="type-name">Float</span><span>   = </span><span class="type-name">SEA_FREQ</span><span>
        </span><span class="keyword">var</span><span> </span><span class="identifier">amp</span><span>: </span><span class="type-name">Float</span><span>    = </span><span class="type-name">SEA_HEIGHT</span><span>
        </span><span class="keyword">var</span><span> </span><span class="identifier">choppy</span><span>: </span><span class="type-name">Float</span><span> = </span><span class="type-name">SEA_CHOPPY</span><span>
        </span><span class="keyword">var</span><span> </span><span class="identifier">uv</span><span>: </span><span class="identifier">vec2</span><span>      = </span><span class="identifier">p</span><span>.</span><span class="identifier">xz</span><span>
        </span><span class="identifier">uv</span><span> = </span><span class="identifier">vec2</span><span>(</span><span class="identifier">uv</span><span>.</span><span class="identifier">x</span><span> * </span><span class="number-literal">0.75f</span><span>, </span><span class="identifier">uv</span><span>.</span><span class="identifier">y</span><span>)

        </span><span class="keyword">var</span><span> </span><span class="identifier">d</span><span>: </span><span class="type-name">Float</span><span> = </span><span class="number-literal">0.0f</span><span>
        </span><span class="keyword">var</span><span> </span><span class="identifier">h</span><span>        = </span><span class="number-literal">0.0f</span><span>
        </span><span class="identifier">cfor</span><span>(</span><span class="number-literal">0</span><span>, </span><span class="identifier">_</span><span> &lt; </span><span class="type-name">ITER_GEOMETRY</span><span>, </span><span class="identifier">_</span><span> + </span><span class="number-literal">1</span><span>) { </span><span class="identifier">_</span><span> =&gt;
          </span><span class="identifier">d</span><span> = </span><span class="identifier">sea_octave</span><span>((</span><span class="identifier">uv</span><span> + </span><span class="type-name">SEA_TIME</span><span>) * </span><span class="identifier">freq</span><span>, </span><span class="identifier">choppy</span><span>)
          </span><span class="identifier">d</span><span> += </span><span class="identifier">sea_octave</span><span>((</span><span class="identifier">uv</span><span> - </span><span class="type-name">SEA_TIME</span><span>) * </span><span class="identifier">freq</span><span>, </span><span class="identifier">choppy</span><span>)
          </span><span class="identifier">h</span><span> += </span><span class="identifier">d</span><span> * </span><span class="identifier">amp</span><span>
          </span><span class="identifier">uv</span><span> = </span><span class="identifier">uv</span><span> * </span><span class="identifier">octave_m</span><span>
          </span><span class="identifier">freq</span><span> *= </span><span class="number-literal">1.9f</span><span>
          </span><span class="identifier">amp</span><span> *= </span><span class="number-literal">0.22f</span><span>
          </span><span class="identifier">choppy</span><span> = </span><span class="identifier">mix</span><span>(</span><span class="identifier">choppy</span><span>, </span><span class="number-literal">1.0f</span><span>, </span><span class="number-literal">0.2f</span><span>)
        }

        </span><span class="identifier">p</span><span>.</span><span class="identifier">y</span><span> - </span><span class="identifier">h</span><span>
      }

      </span><span class="keyword">def</span><span> </span><span class="declaration-name">getSeaColor</span><span>(</span><span class="identifier">p</span><span>: </span><span class="identifier">vec3</span><span>, </span><span class="identifier">n</span><span>: </span><span class="identifier">vec3</span><span>, </span><span class="identifier">l</span><span>: </span><span class="identifier">vec3</span><span>, </span><span class="identifier">eye</span><span>: </span><span class="identifier">vec3</span><span>, </span><span class="identifier">dist</span><span>: </span><span class="identifier">vec3</span><span>): </span><span class="identifier">vec3</span><span> =
        </span><span class="keyword">var</span><span> </span><span class="identifier">fresnel</span><span>: </span><span class="type-name">Float</span><span> = </span><span class="identifier">clamp</span><span>(</span><span class="number-literal">1.0f</span><span> - </span><span class="identifier">dot</span><span>(</span><span class="identifier">n</span><span>, -</span><span class="identifier">eye</span><span>), </span><span class="number-literal">0.0f</span><span>, </span><span class="number-literal">1.0f</span><span>)
        </span><span class="identifier">fresnel</span><span> = </span><span class="identifier">pow</span><span>(</span><span class="identifier">fresnel</span><span>, </span><span class="number-literal">3.0f</span><span>) * </span><span class="number-literal">0.5f</span><span>

        </span><span class="keyword">val</span><span> </span><span class="identifier">reflected</span><span>: </span><span class="identifier">vec3</span><span> = </span><span class="identifier">getSkyColor</span><span>(</span><span class="identifier">reflect</span><span>(</span><span class="identifier">eye</span><span>, </span><span class="identifier">n</span><span>))
        </span><span class="keyword">val</span><span> </span><span class="identifier">refracted</span><span>: </span><span class="identifier">vec3</span><span> = </span><span class="type-name">SEA_BASE</span><span> + </span><span class="identifier">diffuse</span><span>(</span><span class="identifier">n</span><span>, </span><span class="identifier">l</span><span>, </span><span class="number-literal">80.0f</span><span>) * </span><span class="type-name">SEA_WATER_COLOR</span><span> * </span><span class="number-literal">0.12f</span><span>

        </span><span class="keyword">var</span><span> </span><span class="identifier">color</span><span>: </span><span class="identifier">vec3</span><span> = </span><span class="identifier">mix</span><span>(</span><span class="identifier">refracted</span><span>, </span><span class="identifier">reflected</span><span>, </span><span class="identifier">fresnel</span><span>)

        </span><span class="keyword">val</span><span> </span><span class="identifier">atten</span><span>: </span><span class="type-name">Float</span><span> = </span><span class="identifier">max</span><span>(</span><span class="number-literal">1.0f</span><span> - </span><span class="identifier">dot</span><span>(</span><span class="identifier">dist</span><span>, </span><span class="identifier">dist</span><span>) * </span><span class="number-literal">0.001f</span><span>, </span><span class="number-literal">0.0f</span><span>)
        </span><span class="identifier">color</span><span> += </span><span class="type-name">SEA_WATER_COLOR</span><span> * (</span><span class="identifier">p</span><span>.</span><span class="identifier">y</span><span> - </span><span class="type-name">SEA_HEIGHT</span><span>) * </span><span class="number-literal">0.18f</span><span> * </span><span class="identifier">atten</span><span>

        </span><span class="identifier">color</span><span> += </span><span class="identifier">vec3</span><span>(</span><span class="identifier">specular</span><span>(</span><span class="identifier">n</span><span>, </span><span class="identifier">l</span><span>, </span><span class="identifier">eye</span><span>, </span><span class="number-literal">60.0f</span><span>))

        </span><span class="identifier">color</span><span>

      </span><span class="comment">// tracing
</span><span>      </span><span class="keyword">def</span><span> </span><span class="declaration-name">getNormal</span><span>(</span><span class="identifier">p</span><span>: </span><span class="identifier">vec3</span><span>, </span><span class="identifier">eps</span><span>: </span><span class="type-name">Float</span><span>): </span><span class="identifier">vec3</span><span> =
        </span><span class="keyword">var</span><span> </span><span class="identifier">n</span><span>: </span><span class="identifier">vec3</span><span> = </span><span class="literal-value">null</span><span>
        </span><span class="identifier">n</span><span> = </span><span class="identifier">vec3</span><span>(</span><span class="identifier">n</span><span>.</span><span class="identifier">x</span><span>, </span><span class="identifier">map</span><span>(</span><span class="identifier">p</span><span>), </span><span class="identifier">n</span><span>.</span><span class="identifier">z</span><span>)
        </span><span class="identifier">n</span><span> = </span><span class="identifier">vec3</span><span>(</span><span class="identifier">map</span><span>(</span><span class="identifier">vec3</span><span>(</span><span class="identifier">p</span><span>.</span><span class="identifier">x</span><span> + </span><span class="identifier">eps</span><span>, </span><span class="identifier">p</span><span>.</span><span class="identifier">y</span><span>, </span><span class="identifier">p</span><span>.</span><span class="identifier">z</span><span>)) - </span><span class="identifier">n</span><span>.</span><span class="identifier">y</span><span>, </span><span class="identifier">n</span><span>.</span><span class="identifier">y</span><span>, </span><span class="identifier">n</span><span>.</span><span class="identifier">z</span><span>)
        </span><span class="identifier">n</span><span> = </span><span class="identifier">vec3</span><span>(</span><span class="identifier">n</span><span>.</span><span class="identifier">x</span><span>, </span><span class="identifier">n</span><span>.</span><span class="identifier">y</span><span>, </span><span class="identifier">map</span><span>(</span><span class="identifier">vec3</span><span>(</span><span class="identifier">p</span><span>.</span><span class="identifier">x</span><span>, </span><span class="identifier">p</span><span>.</span><span class="identifier">y</span><span>, </span><span class="identifier">p</span><span>.</span><span class="identifier">z</span><span> + </span><span class="identifier">eps</span><span>)) - </span><span class="identifier">n</span><span>.</span><span class="identifier">y</span><span>)
        </span><span class="identifier">n</span><span> = </span><span class="identifier">vec3</span><span>(</span><span class="identifier">n</span><span>.</span><span class="identifier">x</span><span>, </span><span class="identifier">eps</span><span>, </span><span class="identifier">n</span><span>.</span><span class="identifier">z</span><span>)
        </span><span class="identifier">normalize</span><span>(</span><span class="identifier">n</span><span>)

      </span><span class="keyword">var</span><span> </span><span class="identifier">pOut</span><span>: </span><span class="identifier">vec3</span><span> = </span><span class="identifier">vec3</span><span>(</span><span class="number-literal">0.0</span><span>)
      </span><span class="keyword">def</span><span> </span><span class="declaration-name">heightMapTracing</span><span>(</span><span class="identifier">ori</span><span>: </span><span class="identifier">vec3</span><span>, </span><span class="identifier">dir</span><span>: </span><span class="identifier">vec3</span><span>): </span><span class="type-name">Float</span><span> =
        </span><span class="keyword">var</span><span> </span><span class="identifier">tm</span><span>: </span><span class="type-name">Float</span><span> = </span><span class="number-literal">0.0f</span><span>
        </span><span class="keyword">var</span><span> </span><span class="identifier">tx</span><span>: </span><span class="type-name">Float</span><span> = </span><span class="number-literal">1000.0f</span><span>
        </span><span class="keyword">var</span><span> </span><span class="identifier">hx</span><span>: </span><span class="type-name">Float</span><span> = </span><span class="identifier">map</span><span>(</span><span class="identifier">ori</span><span> + </span><span class="identifier">dir</span><span> * </span><span class="identifier">tx</span><span>)

        </span><span class="keyword">var</span><span> </span><span class="identifier">res</span><span> = </span><span class="number-literal">0.0f</span><span>
        </span><span class="keyword">if</span><span> (</span><span class="identifier">hx</span><span> &gt; </span><span class="number-literal">0.0f</span><span>) {
          </span><span class="identifier">pOut</span><span> = </span><span class="identifier">ori</span><span> + </span><span class="identifier">dir</span><span> * </span><span class="identifier">tx</span><span>
          </span><span class="identifier">res</span><span> = </span><span class="identifier">tx</span><span>
        } </span><span class="keyword">else</span><span> {
          </span><span class="keyword">var</span><span> </span><span class="identifier">hm</span><span>: </span><span class="type-name">Float</span><span>   = </span><span class="identifier">map</span><span>(</span><span class="identifier">ori</span><span> + </span><span class="identifier">dir</span><span> * </span><span class="identifier">tm</span><span>)
          </span><span class="keyword">var</span><span> </span><span class="identifier">tmid</span><span>: </span><span class="type-name">Float</span><span> = </span><span class="number-literal">0.0f</span><span>

          </span><span class="identifier">cfor</span><span>(</span><span class="number-literal">0</span><span>, </span><span class="identifier">_</span><span> &lt; </span><span class="type-name">NUM_STEPS</span><span>, </span><span class="identifier">_</span><span> + </span><span class="number-literal">1</span><span>) { </span><span class="identifier">_</span><span> =&gt;
            </span><span class="identifier">tmid</span><span> = </span><span class="identifier">mix</span><span>(</span><span class="identifier">tm</span><span>, </span><span class="identifier">tx</span><span>, </span><span class="identifier">hm</span><span> / (</span><span class="identifier">hm</span><span> - </span><span class="identifier">hx</span><span>))
            </span><span class="identifier">pOut</span><span> = </span><span class="identifier">ori</span><span> + </span><span class="identifier">dir</span><span> * </span><span class="identifier">tmid</span><span>
            </span><span class="keyword">val</span><span> </span><span class="identifier">hmid</span><span>: </span><span class="type-name">Float</span><span> = </span><span class="identifier">map</span><span>(</span><span class="identifier">pOut</span><span>)
            </span><span class="keyword">if</span><span> (</span><span class="identifier">hmid</span><span> &lt; </span><span class="number-literal">0.0f</span><span>) {
              </span><span class="identifier">tx</span><span> = </span><span class="identifier">tmid</span><span>
              </span><span class="identifier">hx</span><span> = </span><span class="identifier">hmid</span><span>
            } </span><span class="keyword">else</span><span> {
              </span><span class="identifier">tm</span><span> = </span><span class="identifier">tmid</span><span>
              </span><span class="identifier">hm</span><span> = </span><span class="identifier">hmid</span><span>
            }
          }

          </span><span class="identifier">res</span><span> = </span><span class="identifier">tmid</span><span>
        }
        </span><span class="identifier">res</span><span>

      </span><span class="keyword">def</span><span> </span><span class="declaration-name">getPixel</span><span>(</span><span class="identifier">coord</span><span>: </span><span class="identifier">vec2</span><span>, </span><span class="identifier">time</span><span>: </span><span class="type-name">Float</span><span>): </span><span class="identifier">vec3</span><span> = {
        </span><span class="keyword">var</span><span> </span><span class="identifier">uv</span><span>: </span><span class="identifier">vec2</span><span> = </span><span class="identifier">coord</span><span> / </span><span class="identifier">env</span><span>.</span><span class="identifier">iResolution</span><span>.</span><span class="identifier">xy</span><span>
        </span><span class="identifier">uv</span><span> = </span><span class="identifier">uv</span><span> * </span><span class="number-literal">2.0f</span><span> - </span><span class="number-literal">1.0f</span><span>
        </span><span class="identifier">uv</span><span> = </span><span class="identifier">vec2</span><span>(</span><span class="identifier">uv</span><span>.</span><span class="identifier">x</span><span> * (</span><span class="identifier">env</span><span>.</span><span class="identifier">iResolution</span><span>.</span><span class="identifier">x</span><span> / </span><span class="identifier">env</span><span>.</span><span class="identifier">iResolution</span><span>.</span><span class="identifier">y</span><span>), </span><span class="identifier">uv</span><span>.</span><span class="identifier">y</span><span>)

        </span><span class="comment">// ray
</span><span>        </span><span class="keyword">val</span><span> </span><span class="identifier">ang</span><span>: </span><span class="identifier">vec3</span><span> = </span><span class="identifier">vec3</span><span>(</span><span class="identifier">sin</span><span>(</span><span class="identifier">time</span><span> * </span><span class="number-literal">3.0f</span><span>) * </span><span class="number-literal">0.1f</span><span>, </span><span class="identifier">sin</span><span>(</span><span class="identifier">time</span><span>) * </span><span class="number-literal">0.2f</span><span> + </span><span class="number-literal">0.3f</span><span>, </span><span class="identifier">time</span><span>)
        </span><span class="keyword">val</span><span> </span><span class="identifier">ori</span><span>: </span><span class="identifier">vec3</span><span> = </span><span class="identifier">vec3</span><span>(</span><span class="number-literal">0.0f</span><span>, </span><span class="number-literal">3.5f</span><span>, </span><span class="identifier">time</span><span> * </span><span class="number-literal">5.0f</span><span>)
        </span><span class="keyword">var</span><span> </span><span class="identifier">dir</span><span>: </span><span class="identifier">vec3</span><span> = </span><span class="identifier">normalize</span><span>(</span><span class="identifier">vec3</span><span>(</span><span class="identifier">uv</span><span>.</span><span class="identifier">xy</span><span>, -</span><span class="number-literal">2.0f</span><span>))
        </span><span class="identifier">dir</span><span> = </span><span class="identifier">vec3</span><span>(</span><span class="identifier">dir</span><span>.</span><span class="identifier">xy</span><span>, </span><span class="identifier">dir</span><span>.</span><span class="identifier">z</span><span> + (</span><span class="identifier">length</span><span>(</span><span class="identifier">uv</span><span>) * </span><span class="number-literal">0.14f</span><span>))
        </span><span class="identifier">dir</span><span> = </span><span class="identifier">normalize</span><span>(</span><span class="identifier">dir</span><span>) * </span><span class="identifier">fromEuler</span><span>(</span><span class="identifier">ang</span><span>)

        </span><span class="comment">// tracing
</span><span>        </span><span class="identifier">heightMapTracing</span><span>(</span><span class="identifier">ori</span><span>, </span><span class="identifier">dir</span><span>)
        </span><span class="keyword">val</span><span> </span><span class="identifier">dist</span><span>: </span><span class="identifier">vec3</span><span>  = </span><span class="identifier">pOut</span><span> - </span><span class="identifier">ori</span><span>
        </span><span class="keyword">val</span><span> </span><span class="identifier">n</span><span>: </span><span class="identifier">vec3</span><span>     = </span><span class="identifier">getNormal</span><span>(</span><span class="identifier">pOut</span><span>, </span><span class="identifier">dot</span><span>(</span><span class="identifier">dist</span><span>, </span><span class="identifier">dist</span><span>) * </span><span class="type-name">EPSILON_NRM</span><span>)
        </span><span class="keyword">val</span><span> </span><span class="identifier">light</span><span>: </span><span class="identifier">vec3</span><span> = </span><span class="identifier">normalize</span><span>(</span><span class="identifier">vec3</span><span>(</span><span class="number-literal">0.0f</span><span>, </span><span class="number-literal">1.0f</span><span>, </span><span class="number-literal">0.8f</span><span>))

        </span><span class="comment">// color
</span><span>        </span><span class="identifier">mix</span><span>(
          </span><span class="identifier">getSkyColor</span><span>(</span><span class="identifier">dir</span><span>),
          </span><span class="identifier">getSeaColor</span><span>(</span><span class="identifier">pOut</span><span>, </span><span class="identifier">n</span><span>, </span><span class="identifier">light</span><span>, </span><span class="identifier">dir</span><span>, </span><span class="identifier">dist</span><span>),
          </span><span class="identifier">pow</span><span>(</span><span class="identifier">smoothstep</span><span>(</span><span class="number-literal">0.0f</span><span>, -</span><span class="number-literal">0.02f</span><span>, </span><span class="identifier">dir</span><span>.</span><span class="identifier">y</span><span>), </span><span class="number-literal">0.2f</span><span>)
        )
      }

      </span><span class="comment">// main
</span><span>      </span><span class="keyword">def</span><span> </span><span class="declaration-name">mainImage</span><span>(</span><span class="identifier">fragColor</span><span>: </span><span class="identifier">vec4</span><span>, </span><span class="identifier">fragCoord</span><span>: </span><span class="identifier">vec2</span><span>): </span><span class="identifier">vec4</span><span> =
        </span><span class="keyword">val</span><span> </span><span class="identifier">time</span><span>: </span><span class="type-name">Float</span><span> = </span><span class="identifier">env</span><span>.</span><span class="identifier">iTime</span><span> * </span><span class="number-literal">0.3f</span><span> + </span><span class="identifier">env</span><span>.</span><span class="identifier">iMouse</span><span>.</span><span class="identifier">x</span><span> * </span><span class="number-literal">0.01f</span><span>

        </span><span class="keyword">val</span><span> </span><span class="identifier">color</span><span>: </span><span class="identifier">vec3</span><span> = </span><span class="identifier">getPixel</span><span>(</span><span class="identifier">fragCoord</span><span>, </span><span class="identifier">time</span><span>)

        </span><span class="identifier">vec4</span><span>(</span><span class="identifier">pow</span><span>(</span><span class="identifier">color</span><span>, </span><span class="identifier">vec3</span><span>(</span><span class="number-literal">0.65f</span><span>)), </span><span class="number-literal">1.0f</span><span>)
    }</span></code></pre>
        <p>Then to get the code as a String so that we might print it or output it to a file or whatever,
        we can do the following:</p>
        <pre class="keep-together pdf epub"><code class="nohighlight"><span class="keyword">object</span><span> </span><span class="type-name">Output</span><span>:

  </span><span class="keyword">val</span><span> </span><span class="identifier">imageCode</span><span>: </span><span class="type-name">String</span><span> =
    </span><span class="type-name">ShaderToyExample</span><span>.</span><span class="identifier">image</span><span>.</span><span class="identifier">toGLSL</span><span>[</span><span class="type-name">ShaderToy</span><span>].</span><span class="identifier">toOutput</span><span>.</span><span class="identifier">code</span></code></pre>

        
<hr class="footer-rule"/>
<footer>
  Site generated by <a href="https://typelevel.org/Laika/">Laika</a> with the Helium theme.
</footer>


      </main>

    </div>

  </body>

</html>